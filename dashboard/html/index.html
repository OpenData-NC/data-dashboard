<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Dashboard search</title>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css" />
    </head>
    
    <body>
    <div class="container">

            <div class="row hidden-xs" >
                <div class="col-md-10 col-xs-6">
                    <div class="radio">
                        <p><b>County to search</b></p>
                        <label class="radio-inline">
                            <input name="county_locations" type="radio" class="county-location" data-location="Buncombe" value="1">
                            Buncombe County
                        </label>
                        <label class="radio-inline">
                            <input name="county_locations" type="radio" class="county-location" data-location="New Hanover" value="1" checked >
                            New Hanover County
                        </label>
                        <label class="radio-inline">
                            <input name="county_locations" type="radio" class="county-location" data-location="Wake" value="1">
                            Wake County
                        </label>
                    </div>
                </div>
            </div>
            <div class="row visible-xs-block">
                <div class="col-md-10 col-xs-8">
                    <div class="radio">
                        <p><b>County to search</b></p>
                        <label class="radio">
                            <input name="county_locations" type="radio" class="county-location" data-location="Buncombe" value="1">
                            Buncombe County
                        </label>
                        <label class="radio">
                            <input name="county_locations" type="radio" class="county-location" data-location="New Hanover" value="1" checked>
                            New Hanover County
                        </label>
                        <label class="radio">
                            <input name="county_locations" type="radio" class="county-location" data-location="Wake" value="1">
                            Wake County
                        </label>
                    </div>
                </div>
            </div>



    <div class="row">
        <form>
            <div class="row"  style="margin-bottom: .5em">
                <div class="col-md-4 col-xs-10">
                    <label for="first-name" class="control-label">First name</label>
                        <input type="text" class="form-control search-item" id="first-name" placeholder="First name">
                </div>
                <div class="col-md-4 col-xs-10">

                    <label for="last-name" class="control-label">Last name</label>
                        <input type="text" class="form-control search-item" id="last-name" placeholder="Last name">
                </div>
            </div>
            <div class="row" style="margin-bottom: .5em">
                <div class="col-md-4 col-xs-10">
                    <label for="from-date" class="control-label">From or on </label>
                        <input type="date" class="form-control search-item" id="from-date">
                </div>
                <div class="col-md-4 col-xs-10">
                    <label for="to-date" class="control-label">To (only if range)</label>
                        <input type="date" class="form-control search-item" id="to-date">
                </div>
            </div>
            <div class="row">
                <div class="col-md-4 col-xs-10">
            
                <b>Address</b>
                </div>
            </div>
            <div class="row">
                <div class="col-md-4 col-xs-10">
                    <label for="street-number" class="control-label">Street number </label>
                        <input type="text" class="form-control search-item" id="street-number" placeholder="Ex. 123">
                </div>
                <div class="col-md-4 col-xs-10">
                    <label for="street-name" class="control-label">Street name </label>
                        <input type="text" class="form-control search-item" id="street-name" placeholder="Main">
                </div>
            </div>
            <div class="row hidden-xs" >
                <div class="col-md-10 col-xs-6">
                    <div class="checkbox">
                        <p><b>Categories to search</b></p>
                        <label class="checkbox-inline">
                            <input type="checkbox" id="crime" class="data-type" value="1">
                            Police and sheriff
                        </label>
                        <label class="checkbox-inline">
                            <input type="checkbox" id="property" class="data-type" value="1">
                            Property tax
                        </label>
                        <label class="checkbox-inline">
                            <input type="checkbox" id="realestate" class="data-type" value="1">
                            Real estate transactions
                        </label>
                        <label class="checkbox-inline">
                            <input type="checkbox" id="health" class="data-type" value="1">
                            Public health inspections
                        </label>
                        <label class="checkbox-inline">
                            <input type="checkbox" id="voter" class="data-type" value="1">
                            Voter registration
                        </label>
                    </div>
                </div>
            </div>
            <div class="row visible-xs-block">
                <div class="col-md-10 col-xs-6">
                    <div class="checkbox">
                        <p><b>Categories to search</b></p>
                        <label>
                            <input type="checkbox" id="crime" class="data-type" value="1">
                            Police and sheriff
                        </label>
                        <label>
                            <input type="checkbox" id="property" class="data-type" value="" disabled>
                            Property tax
                        </label>
                        <label>
                            <input type="checkbox" id="realestate" class="data-type" value="" disabled>
                            Real estate transactions
                        </label>
                        <label>
                            <input type="checkbox" id="health" class="data-type" value="" disabled>
                            Public health inspections
                        </label>
                        <label>
                            <input type="checkbox" id="voter" class="data-type" value="1">
                            Voter registration
                        </label>
                    </div>
                </div>
            </div>

            <div class="row">
            <div class="col-sm-4">
            <button type="button" class="btn btn-default" id="search">Search</button>
            <button class="btn btn-default" type="reset">Reset</button>
            </div>
            </div>
        </form>

    </div>
            <div class="row">
                <div class="col-md-10 col-xs-10" id="data-tables">
                </div>

            </div>
    </div>

    
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?sensor=true&libraries=geometry"></script>
    <script src="lib/js/handlebars.js"></script>
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    
    <script>
    (function(){
        google.load("visualization", "1", {packages:["table"]});
        $('#search').click(function(){
            query = find_query_params();
            query?query_data(query):error();
            
            function query_data(query) {
                $('#data-tables').empty();
                $('#data-tables').html('<h2>Searching ...</h2>');
                $.get(query)
                    .done(function(data){
                        show_data(data);
                    });

            }
            function error(){
                $('#data-tables').html('<h4 class="text-danger">WTF?? Specify at least one search category.</h4>');
                
            }
            function find_query_params() {
                var search_params = {}
                    , data_types = [];
                $('.search-item').each(function(i,item){
                    if($(item).val() !== '') {
                    search_params[$(item).prop('id')] = $(item).val();
                    }
                });
                $('.data-type').each(function(i,item){
//                $('#crime, #voter').each(function(i,item){
                    if($(item).is(':checked')) {
                        data_types.push($(item).prop('id'));
                    }
                search_params['data_types'] = data_types.join('-');
                });
                return data_types.length === 0?false:build_query(search_params);
            }
            function build_query(search_params) {
                var county = get_county();
//                console.log(county);
                var query = ['county', county]
                    ,base = '/search';
                $.each(search_params, function(key, value) {
                    query.push(key);
                    query.push(value);
                });
                return [base, query.join('|')].join('/');
                
            }
            function show_data(data){
//		console.log(data);
                $('#data-tables').empty();
                for (data_type in data.results) {
//                    console.log(data_type);
//                    console.log(data.results[data_type]);
                    if(data.results[data_type].data.length > 0) {
                        build_table(data_type, data.results[data_type]);
                    }
                }
            };
        });
        function get_county(){
            var county = '';
            $('.county-location').each(function(i,item){
                if($(item).is(':checked')) {
                    county = $(item).data('location');
                }
            });
            if(county === '') { county = 'New Hanover'; }
            return county;
        }
        function build_table(data_type, data_content, page_size){
            if(data_type === 'arrests' || data_type === 'incidents' || data_type === 'accidents' || data_type === 'citations') {
                formatted_table_data = data_content.data.map(function(row) { row[0] = truncate(row[0], 15); return row; });
            }
            else { formatted_table_data = data_content.data; }
            var rows = $('.row');
            var table_width = ($(rows[0]).width() - 50) + 'px';
            page_size = page_size || 20;
            var data = new google.visualization.DataTable();
            data_content.headings.forEach( function(heading) {
                data.addColumn("string",heading);
            });
            data.addRows(formatted_table_data);
            var options = {page:"enable",pageSize:20};
            var table_div_id = 'data-table-' + data_type;
            var table_div = '<h2 style="text-transform: capitalize">' + data_type + ': ' + data_content.data.length + ' records</h2><div style="width:100%" id="' + table_div_id + '"></div>';
            $('#data-tables').append(table_div);
            var table = new google.visualization.Table(document.getElementById(table_div_id));
            table.draw(data,options);
        }
        function truncate(string,length) {
            string = string.length > length ? string.substr(0,length-1) + ' ...': string;
            return string;
        }
    })();
    </script>
 
    </body>
</html>
